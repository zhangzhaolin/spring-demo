# 第三章 高级装配

标签（空格分隔）： 未分类

---

[TOC]

## 环境与profile

### 配置profile bean

在开发过程中，不同开发环境可能会出现代码不同的情况，比方说：一般开发和测试会有两个不同的环境和数据库等等。

一个简单的profile例子：

ProfileConfig.class
```
@Configuration
public class ProfileConfig {

    @Bean
    @Profile("dev") // 指定下面的bean属于dev profile
    public DemoBean devBean(){
        return new DemoBean("这是测试环境");
    }

    @Bean
    @Profile("prod") // 指定下面的bean属于prod profile
    public DemoBean prodBean(){
        return new DemoBean("这是生产环境");
    }

}
```

MainTest.java
```

public class MainTest {

    public static void main(String []args){

        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();

        context.getEnvironment().setActiveProfiles("dev"); // 激活某些profile状态
        context.register(ProfileConfig.class);
        context.refresh();

        DemoBean demoBean = context.getBean(DemoBean.class);

        System.out.println(demoBean.getContent());

        context.close();

    }
}

```

`@Profile` 注解不仅可以加到`@Bean`的下方，还可以加到类上：

```
@Configuration
@Profile(value="prod")
public class ProductionProfileConfig{
    // ...
}
```

表示仅有当`@Profile`中的环境激活时（也就是例子中的prod,dev...），才可以创建相应的bean

除了在Java文件中加上注解之外，我们还可以通过XML配置文件的方法来配置相应的profile：


spring-config.xml
```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jdbc="http://www.springframework.org/schema/jdbc"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"
       profile="prod">

    <jdbc:embedded-database id="dataSource">
        <jdbc:script location="classpath:main/example/sql/dev.sql"/>
        <jdbc:script location="classpath*:main/example/sql/prod.sql"/>
    </jdbc:embedded-database>

    <context:component-scan base-package="main.example"/>

</beans>
```

当prod的profile被激活时，spring-config.xml才会被用到。

我们还可以在一个XML文件中通过`<beans>`标签嵌套定义多个profile

spring-config.xml
```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jdbc="http://www.springframework.org/schema/jdbc"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <beans profile="qa">
        <bean>
            ...
        </bean>
    </beans>
    
    <beans profile="prod">
        ...
    </beans>
    
</beans>
```

### 激活profile

激活profile需要依赖两个独立的属性：

```
spring.profiles.active
spring.profiles.default
```

如果spring.profiles.active和spring.profiles.default均没有设置的话，那就没有激活的profile，因此，只会创建那些没有定义在profile中的bean。

有多种方式来设置这两个属性：
- 作为`DispatcherServlet`的初始化参数
- 作为Web应用的上下文参数
- 作为JNDI条目
- 作为环境变量
- 作为JVM的系统属性
- 在集成测试上，使用@ActiveProfiles注解设置

在web应用中的web.xml中设置默认的profile
web.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="3.1">
    
    <welcome-file-list>
        <welcome-file>index.jsp</welcome-file>
    </welcome-file-list>

    <!-- 为上下文设置默认的profile -->
    <context-param>
        <param-name>spring.profiles.default</param-name>
        <param-value>dev</param-value>
    </context-param>

    <listener>
        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
    </listener>
    
    <!-- Spring Configuration -->
    <servlet>
        <servlet-name>appServlet</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <init-param>
            <!-- 为servlet配置默认的profile -->
            <param-name>spring.profiles.default</param-name>
            <param-value>dev</param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>appServlet</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>


</web-app>
```

### 使用profile进行测试

Spring提供了 `@ActiveProfiles` 注解，来指定运行测试时需要激活哪个profile

```
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "classpath:spring-config.xml")
@ActiveProfiles("prod")
public class UserDaoTest {
    // ...
}
```

## 条件化的bean

假如我们希望某个bean只有当另一个特定的bean声明了之后才会创建，或者需要某个特定的环境变量才会创建，就需要用到 `@Conditional` 注解

它可以用在带有 `@Bean` 注解的方法上，如果给定的条件计算结果为true，就创建这个bean，否则就不创建。

例如，假设有一个MagicBean的类，当设置了magic环境属性的时候，Spring才会实例化这个类：

MagicBeanConfig.class

```
@Configuration
public class MagicBeanConfig {

    @Bean
    @Conditional(MagicExistsCondition.class)
    public MagicBean magicBean(){
        return new MagicBean();
    }

}
```

`@Conditional` 给定了一个class ，它指明了一个条件 —— 在本例中，也就是 `MagicExistsCondition` 类 。`@Conditional` 将会通过 Condition 接口进行对比：

```
@FunctionalInterface
public interface Condition {
    boolean matches(ConditionContext var1, AnnotatedTypeMetadata var2);
}
```

设置给 `@Conditional` 的类可以是任意实现了Condition 接口的类型 。这个接口实现起来需要提供 matches() 方法的实现即可 。如果 matches() 方法返回 true ， 那么就会创建带有 `@Conditional` 注解的bean，否则就不会创建这些 bean 

MagicExistsCondition.class

```
public class MagicExistsCondition implements Condition {

    public boolean matches(ConditionContext conditionContext, AnnotatedTypeMetadata annotatedTypeMetadata) {
        Environment environment = conditionContext.getEnvironment();
        // 检查环境中是否存在magic的环境属性
        return environment.containsProperty("magic");
    }
}
```



